# 任务管理系统技术方案

## 概述

任务管理系统提供了一种统一的方式，通过 CLI 和 MCP 工具来执行、监控和控制 AI 任务。它支持后台和前台两种执行模式，集成了 Spec/Entity 定义加载机制，并提供了健壮的日志记录和状态管理功能。

## 架构设计

### 任务管理器 (`apps/cli/src/mcp-tools/task/manager.ts`)

`TaskManager` 是一个单例服务，负责：

1. **状态管理**: 在内存中维护活跃和已完成任务的状态 (`TaskInfo`)。
2. **执行编排**: 通过 `packages/core` 的 `run()` 控制器调度任务执行。
3. **生命周期控制**: 支持启动、停止和查询任务。
4. **日志捕获**: 实时捕获来自适配器进程的日志流。

### 任务信息结构 (`TaskInfo`)

```typescript
interface TaskInfo {
  taskId: string
  adapter: string
  status: 'running' | 'completed' | 'failed'
  exitCode?: number
  logs: string[]
  session?: AdapterSession
  createdAt: number
  onExit?: () => void
}
```

## 定义加载机制 (`packages/core/src/utils/definition-loader.ts`)

系统支持从 `.ai` 目录加载结构化的定义文件 (Specs/Entities) 来动态配置任务。

### 支持的定义类型

- **Rule**: 全局行为规则。
- **Spec**: 任务规格说明，包含工具/MCP Server 配置。
- **Entity**: 实体定义 (复用 Spec 结构)。
- **Skill**: 可复用的能力单元。

### 加载策略

1. **扫描路径**: 扫描 `.ai/{specs,entities,rules}` 以及 `.ai/plugins/*/` 目录。
2. **解析与注入**: `resolveTaskConfig` 函数将定义的元数据 (tools, mcpServers) 合并到 `AdapterQueryOptions` 中，并将定义内容 (Markdown Body) 注入到 System Prompt。

## MCP 工具集

系统在 CLI 中暴露了以下 MCP 工具，均采用 **PascalCase** 命名规范。

### `StartTasks`

启动一个或多个任务。

- **参数**:
  - `tasks`: 任务配置数组。
    - `adapter`: 适配器名称 (如 'claude-code')。
    - `description`: 任务提示词/描述。
    - `type`: 'spec' | 'entity' (可选)。
    - `name`: 定义名称 (可选)。
    - `background`: 布尔值 (默认 `true`)。
- **行为**:
  - **后台模式 (`true`)**: 立即返回 `taskId`。需调用 `GetTaskStatus` 轮询进度。
  - **前台模式 (`false`)**: 等待任务执行完成，并一次性返回完整的执行日志。

### `GetTaskStatus`

查询任务状态及最近日志。

- **参数**: `taskId`。
- **返回**: 状态、退出码以及最近 10 行日志。

### `StopTask`

终止正在运行的任务。

- **参数**: `taskId`。

### `ListSpecs` / `ListEntities` / `ListTasks`

辅助工具，用于发现可用的定义和查看当前管理的任务列表。

## 日志管理

- **内存存储**: 日志暂存在内存 (`TaskInfo.logs`) 中，以便通过 MCP 快速检索。
- **持久化**: 底层的 `packages/core` logger 会将日志持久化到本地文件 `.ai/logs/<taskId>/<Date>/<sessionId>.log.md`。
- **检索策略**:
  - 前台任务在完成后返回完整累积日志。
  - 后台任务支持通过 `GetTaskStatus` 轮询最近日志。

## 未来规划

- **日志回放**: 支持全量终端回放能力。
- **持久化任务历史**: 在 CLI 重启后保留 `TaskManager` 状态。
